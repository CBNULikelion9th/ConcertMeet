{% extends 'meetapp/base.html' %} {% block content %} {% load static %} <br />
<html>

<head>
    <link rel="stylesheet" href="{% static 'css/post_detail.css' %}" />
    <script src="{% static 'js/likes.js' %}"></script>
</head>

<body>
    <section class="det_container">
        <section id="title">
            <h2>{{ post.title }}</h2>

            <div class="user_and_pcp">
                <p>
                    #{{ post.category }}
                    | 
                    <span id="pcp_user_cnt" value="{{ post.pcp.pcp_user_count }}">{{ post.pcp.pcp_user_count }}</span>
                     /
                    <span id="pcp_total_cnt" value="{{ post.pcp.pcp_user_total }}">{{ post.pcp.pcp_user_total }}</span> 명
                    <br>
                    <a href="{% url 'account:user' post.user.username %}">{{ post.user.name }}</a>
                </p>
            </div>
        </section>
    
        <section id="content">
            <p>{{ post.content|linebreaks }}</p>
        </section>
    
        <section id="edit">
            <div class="manage">
                {% if post.user.username == request.user.username %}
                <a href="{% url 'meetapp:post_edit' post.id %}"><button>수정</button></a>
                <input type="hidden" id="del_post_url" value="{% url 'meetapp:post_delete' post.id %}">
                <button onclick="deletefunc();">삭제</button>
                {% if is_pcp %}
                <a href="{% url 'account:review_new' info.username %}" class='btn btn-primary float-end'>후기 작성</a>
                {% endif %}
                {% else %}
                <a>
                    <button class="like" name="{{ post.id }}" onclick="onClick()">
                        <span class="fa fa-heart"></span>
                    </button>
                </a>
                <a href="{% url 'meetapp:post_declaration' post.id %}"><button>신고</button></a>
                {% endif %}
                <a href="{% url 'meetapp:post_list' %}"><button>목록</button></a>
            </div>
        </section>

        <hr>

        <section id="comment">
            <h4>댓글</h4>
            <form action="{% url 'meetapp:comment_new' post.id %}" method="POST" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="form-group">
                    <textarea cols="40" rows="3" class="form-control" name="message" id="message"
                        value="{{ form.message.value|default_if_none:'' }}" placeholder="댓글로 참가 의사를 표현하세요"></textarea>
                </div>
                <div class="d-grid gap-2 d-sm-flex justify-content-sm-end">
                    <input type="submit" class="comment_new_btn" value="작성">
                </div>
            </form>

            <ul>
                {% for comment in post.comment_set.all %}
                <li>
                    <div class="cmt_edit_msg_{{ comment.id }}">
                        {% if comment.user.username == request.user.username %}
                        <!-- <a href="{{ comment.get_edit_url }}">
                            <button id="cmt_edit">수정</button>
                        </a> -->
                        <button class="cmt_edit" onclick="editcmtfunc();">수정</button>
                        <a>
                            <input type="hidden" id="delete_url" name="delete_url" value="{{ comment.get_delete_url }}">
                            <button onclick="deletecmtfunc();">삭제</button>
                        </a>
                        {% endif %}
                        {% if request.user.username == post.user.username and comment.user.username != request.user.username %}
                        <a>
                            <input type="hidden" id="pcp_url" name="pcp_url" value="{% url 'meetapp:pcp_add' post.id comment.id %}">
                            <input type="hidden" id="del_pcp_url" name="del_pcp_url"
                                value="{% url 'meetapp:pcp_delete' post.id comment.id %}">
                            <button id="pcp_btn" onclick="addpcpfunc();">참가자 추가</button>
                            <button id="del_pcp_btn" onclick="delpcpfunc();">참가자 삭제</button>
                        </a>
                        {% endif %}
                    </div>
                    <div class="cmt_tit">
                        <a href="{% url 'account:user' comment.user.username %}">{{ comment.user.name }}</a>
                        | {{ comment.created_at }} <br>
                    </div>
                    <div class="cmt_msg_{{ comment.id }}">
                        {{ comment.message|linebreaks }}<br>
                    </div>
                    
                </li>
                {% endfor %}
            </ul>
        </section>
    </section>
</body>
</html>

<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
<script type="text/javascript">
    $(".btn-icon").click(function () {
        // .like 버튼을 클릭 감지
        var pk = $(this).attr("name"); // Jquery의 경우에는 이벤트가 발생한 요소의 정보들이 Object로 표시
        $.ajax({
            // ajax로 서버와 통신
            type: "POST", // 데이터를 전송하는 방법
            url: "{% url 'meetapp:post_like' %}", // 통신할 url을 지정
            data: { pk: pk, csrfmiddlewaretoken: "{{ csrf_token }}" }, // 서버로 데이터 전송시 옵션, pk를 넘겨야 어떤 post인지 알 수 있음
            dataType: "json",
            success: function (response) {
                // 성공
                $("#count-" + pk).html(response.likes_count); // 좋아요 개수 변경
            },
            error: function (request, status, error) {
                // 실패
                alert("로그인이 필요합니다.");
                window.location.replace("/user/login/"); // 로그인 페이지로 넘어가기
            },
        });
    });
    function deletefunc() {
        if (confirm('정말 삭제하시겠습니까?'))
            window.location = document.getElementById("del_post_url").value;;
    }

    $(".cmt_edit").click(function () {
        var cid = $(this).attr("name");
        var form_str = '<form action="{{ comment.get_edit_url }}" method="POST">{% csrf_token %}<textarea cols="40" rows="3" class="form-control" name="message" id="message" value="{{ comment.message|linebreaks }}"></textarea></form>';
        $(".cmt_edit_msg_" + cid).html(form_str);
    });

    function deletecmtfunc() {
        if (confirm('정말 삭제하시겠습니까?'))
            window.location = document.getElementById("delete_url").value;
    }
    function addpcpfunc() {
        
        if (confirm('해당 사용자를 추가하시겠습니까?')) {
            var cur = document.getElementById("pcp_user_cnt").value;
            console.log(cur)
            var tot = document.getElementById("pcp_total_cnt").value;
            console.log(tot)
            if(tot - cur == 0)
                alert("최대인원을 초과하여 추가할 수 없습니다.");
            else {
                $.ajax({
                type: "POST",
                url: document.getElementById("pcp_url").value,
                data: { 'csrfmiddlewaretoken': '{{ csrf_token }}' },
                dataType: "json",
                success: function (response) {
                    alert("성공적으로 추가되었습니다.");
                    $("#pcp_user_cnt").text(response.pcp_user_count);
                },
                error: function (request, status, error) {
                    if (status == 0)
                        alert("이미 등록된 사용자입니다.");
                    else
                        alert("추가에 실패하였습니다.");
                },
            });
            }
        }
    }
    function delpcpfunc() {
        if (confirm('해당 사용자를 제외하시겠습니까?')) {
            $.ajax({
                type: "POST",
                url: document.getElementById("del_pcp_url").value,
                data: { 'csrfmiddlewaretoken': '{{ csrf_token }}' },
                dataType: "json",
                success: function (response) {
                    alert("성공적으로 삭제되었습니다.");
                    $("#pcp_user_cnt").text(response.pcp_user_count);
                },
                error: function (request, status, error) {
                    if (status == 0)
                        alert("참가하지 않은 사용자입니다.");
                    else
                        alert("삭제에 실패하였습니다.");
                },
            });
        }
    }
</script>
{% endblock content %}