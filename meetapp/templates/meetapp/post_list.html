{% extends 'meetapp/base.html' %} 
{% block content %} 
{% load static %}
<html>
  <head>
    <link rel="stylesheet" href="{% static 'css/post_list.css' %}" />
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@100;300;400&display=swap" 
        rel="stylesheet">
    <link rel="preconnect" href="https://fonts.gstatic.com" />
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR&display=swap" rel="stylesheet"/>
  </head>

  <body>
    <section id="main">
      <div class="title">
        <h1>콘서트 메이트 구해요</h1>

        <a href="{% url 'meetapp:post_new' %}" class="btn btn-primary float-end"
          >새 글 쓰기</a
        >
      </div>
        <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR&display=swap" rel="stylesheet"/>
    </head>

      {% for post in post_list %}
      <a href="{% url 'meetapp:post_detail' post.id %}">
        <div class="post_element">
          <div class="page_title">{{ post.title }}&nbsp;[{{ post.hit }}]</div>
          <div class="heart"></div>

          <div class="info">
            <div class="hashtag">
              <p>#힙합</p>
            </div>
            <div class="date">
              <p>
                {{ post.created_at|date:"Y/m/d A h:i " }}&nbsp;&nbsp;&nbsp;{{ post.user }}
              </p>
            </div>
          </div>

          <div class="matching">
            <p>0/3</p>
          </div>
          
          <div>
          <input type="button" class="btn btn-info btn-sm like" name="{{ post.id }}" value="Like"
              style="margin-top: 7px">
          <p id="count-{{ post.id }}" style="font:bold 1em; margin-top: 3px">
              좋아요&nbsp;{{ post.likes_user.all.count }}개</p>
        </div>
        </div>
      </a>

      <br>
      {% endfor %}
      

    </section>
  </body>
</html>
<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
<script type="text/javascript">
    $(".like").click(function () { // .like 버튼을 클릭 감지
        var pk = $(this).attr('name')
        $.ajax({ // ajax로 서버와 통신
            type: "POST", // 데이터를 전송하는 방법
            url: "{% url 'meetapp:post_like' %}", // 통신할 url을 지정
            data: { 'pk': pk, 'csrfmiddlewaretoken': '{{ csrf_token }}' }, // 서버로 데이터 전송시 옵션, pk를 넘겨야 어떤 video인지 알 수 있음
            dataType: "json",
            success: function (response) { // 성공
                alert(response.message);
                $("#count-" + pk).html("좋아요&nbsp;" + response.likes_count + "개"); // 좋아요 개수 변경
            },
            error: function (request, status, error) { // 실패
                alert(error)
                // window.location.replace("/video/login/") // 로그인 페이지로 넘어가기
            },
        });
    })
</script>
{% endblock content %}